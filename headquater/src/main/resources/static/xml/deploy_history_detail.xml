<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head>
    	<w2:type>DEFAULT</w2:type>
        <w2:buildDate/>
        <xf:model>
            <xf:instance>
                <data xmlns=""/>
            </xf:instance>
            <w2:dataCollection baseNode="map">
            </w2:dataCollection>
            <w2:workflowCollection>
            </w2:workflowCollection>
        </xf:model>
		 <script type="text/javascript" src="/js/lib/qrcode.min.js"></script>
         <script type="text/javascript" lazy="false"><![CDATA[
	scwin.onpageload = function() {
		common.setScopeObj(scwin);
		scwin.initPage();
	};

	scwin.onpageunload = function() {

	};

	scwin.initPage = function(){
		var historyPlatform = localStorage.getItem("historyPlatform");
		var historyProjectName = localStorage.getItem("historyProjectName");
		var historyProjectId = localStorage.getItem("historyProjectId");

		var data = {};
		data.projectID = historyProjectId;

		var options = {};
		options.action = "/manager/deploy/history/search/historyList";
		options.mode = "asynchronous";
		options.mediatype = "application/json";
		options.method = "POST";
		options.requestData = JSON.stringify(data);

		options.success = function (e) {
			var data = e.responseJSON;
			if (data != null) {

				scwin.selecthistorydetail(data);

				$(".qrcode").click(function(){
					$(".layer_pop").css("display","block").css("width","180px").css("height","220px");
					$("body").append("<div class='dim'></div>");
				});
				$(".btn_pop_close").click(function(){
					$(".layer_pop").css("display","none");
					$("div").remove(".dim");
				});

			} else {
                var message = common.getLabel("lbl_failed_history");
				alert(message);
			}
		};

		options.error = function (e) {
			alert("message:"+e.responseText+"\n");

		};

		$p.ajax(options);
	};

	scwin.webSocketCallback = function(obj) {
		switch (obj.MsgType) {
			case "HV_MSG_APP_DOWNLOAD_STATUS_INFO_FROM_HEADQUATER" :
				scwin.setBuilderAppDownloadHref(obj);
				break;
			case "HV_MSG_APP_DOWNLOAD_STATUS_INFO" :
				// scwin.setBranchAppDownloadStatus(obj);
				break;
			default :
				break;
		}
	};

	scwin.setBuilderAppDownloadHref =  function (data){

		// app file 다운로드
		window.location = "/manager/build/history/downloadSetupFile/" + data.filename;
	}

	scwin.selecthistorydetail = function(data){

		var historyProjectName = localStorage.getItem("historyProjectName");

        var message = common.getLabel("lbl_project_history");
		txt_project_history_name.setValue(historyProjectName + " " + message); // Project 기록

		for (var idx in data) {
			list_buildhistory_detail_generator.insertChild();

			var txt_proj_history_list = list_buildhistory_detail_generator.getChild(idx, "txt_proj_history");
			var txt_build_start_date_list = list_buildhistory_detail_generator.getChild(idx, "txt_build_start_date");
			var txt_build_end_date_list = list_buildhistory_detail_generator.getChild(idx, "txt_build_end_date");
			var txt_history_build_project_name_list = list_buildhistory_detail_generator.getChild(idx, "txt_history_build_project_name");
			var txt_history_logfile_download_url_list = list_buildhistory_detail_generator.getChild(idx, "history_logfile_url");

			var history_id = parseInt(data[idx].deploy_history_id);
			var build_id = parseInt(data[idx].project_id);
			var id_idx = parseInt(idx);

			// txt_name success
			if (data[idx].result == "SUCCESSFUL"){
				txt_proj_history_list.changeClass("txt_name fail","txt_name success");
			}else {
				txt_proj_history_list.changeClass("txt_name success","txt_name fail");
			}

			if(data[idx].deploy_start_date != null){
				data[idx].deploy_start_date = data[idx].deploy_start_date.replace(/T/g,' ');
			}

			if(data[idx].deploy_end_date != null){
				data[idx].deploy_end_date = data[idx].deploy_end_date.replace(/T/g,' ');
			}

            var message_status = common.getLabel("lbl_state");
            var message_dist_start_time = common.getLabel("lbl_deploy_history_detail_js_distribute_start_time");
            var message_dist_end_time = common.getLabel("lbl_deploy_history_detail_js_distribute_end_time");
            var message_project_name = common.getLabel("lbl_project_name");

			txt_proj_history_list.setValue(message_status + " : " + data[idx].result);
			txt_build_start_date_list.setValue(message_dist_start_time + " : " + data[idx].deploy_start_date);
			txt_build_end_date_list.setValue(message_dist_end_time + " : " + data[idx].deploy_end_date);
			txt_history_build_project_name_list.setValue(message_project_name + " : " + historyProjectName);

			// history id bind
			txt_history_logfile_download_url_list.setUserData("historyid",data[idx].deploy_history_id);

		}

	};

	scwin.gethistoryfileurl_onclick = function(e){

	    var history_id = this.getUserData("historyid");

	    var data = {};
		var options = {};


		data.history_id = history_id;

		options.action = "/manager/deploy/history/download/logFileFromWebSocket";
		options.mode = "asynchronous";
		options.mediatype = "application/json";
		options.requestData = JSON.stringify(data);
		// options.method = "GET";
		options.method = "POST";

		options.success = function (e) {
			var data = e.responseJSON;
			if (data != null) {

				var buildproj = [];

			} else {

			}
		};

		options.error = function (e) {
			alert("message:"+e.responseText+"\n");

		};

		$p.ajax( options );

	};

	]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload" ev:onpageunload="scwin.onpageunload">
    	<xf:group class="sub_contents" id="" style="">
    		<xf:group id="" style="" class="white_board">
    			<xf:group id="" style="" class="pgtbox">
    				<w2:textbox id="txt_project_history_name" style="" class="pgt_tit fl" label="" useLocale="true" localeRef="lbl_history2"></w2:textbox>
<!--    				<xf:group class="fr" id="" style="">-->
<!--    					<xf:input adjustMaxLength="false" id="" style=""></xf:input>-->
<!--    					<xf:trigger type="button" id="" style="" class="btn_cm">-->
<!--    						<xf:label><![CDATA[검색]]></xf:label>-->
<!--    					</xf:trigger>-->
<!--    				</xf:group>-->
    			</xf:group>
    			<xf:group class="" id="" style="">
					<w2:generator style="" id="list_buildhistory_detail_generator" class="record_box02">
    					<xf:group class="item" id="" style="">
							<xf:group class="rec_tit" id="" style="">
								<w2:textbox class="txt_name success" id="txt_proj_history" label="" style="" toolTip="tooltip" toolTipDisplay="true" useLocale="true" tooltipLocaleRef="lbl_whether_build"></w2:textbox>
								<xf:group class="recbox">
									<w2:textbox style="" id="txt_build_start_date" label="" class="txt_name"></w2:textbox>
									<w2:textbox style="" id="txt_build_end_date" label="" class="txt_name"></w2:textbox>
									<w2:textbox style="" id="txt_history_build_project_name" label="" class="txt_name"></w2:textbox>
								</xf:group>
							</xf:group>
							<xf:group class="rec_link" id="" style="">
								<w2:anchor class="btn_down" id="history_logfile_url" outerDiv="false" style="" href="" ev:onclick="scwin.gethistoryfileurl_onclick"
										   toolTip="tooltip" toolTipDisplay="true" useLocale="true" localeRef="lbl_log_download" tooltipLocaleRef="lbl_deploy_history_detail_tooltip_history_logfile_url">
									<xf:label><![CDATA[]]></xf:label>
								</w2:anchor>
							</xf:group>
						</xf:group>
					</w2:generator>
    			</xf:group>
			</xf:group>
		</xf:group>
		<xf:group class="layer_pop" id="" style="display:none;">
			<xf:group class="ly_head" id="" style="">
				<w2:textbox class="title" id="" label="" style="" useLocale="true" localeRef="lbl_qrcode"></w2:textbox>
				<w2:anchor class="btn_pop_close" id="" outerDiv="false" style="" useLocale="true" localeRef="lbl_close">
					<xf:label><![CDATA[]]></xf:label>
				</w2:anchor>
			</xf:group>
			<xf:group class="ly_cont" id="" style="">
<!--				<xf:group class="form_wrap" id="" style="">-->
					<div id="history_qrcode" style="width: 290px;height:330px;"></div>
<!--				</xf:group>-->
			</xf:group>
		</xf:group>
    	
    </body>
</html>
